# 三级日期选择器功能说明

## 功能概述

修改历史记录功能现在使用年、月、日三级日期选择器，支持选择任意日期（包括没有记录的日期），可以创建新日期的记录或修改已有日期的记录。

## 功能特点

### 1. 三级日期选择器
- **年份选择器**：当前年份前后各10年（共21年可选）
- **月份选择器**：1-12月
- **日期选择器**：根据年月自动计算天数（考虑闰年）

### 2. 智能日期处理
- **自动计算天数**：根据选择的年月自动计算该月的天数
- **闰年支持**：正确处理2月的天数（28天或29天）
- **日期验证**：确保选择的日期有效（如2月30日会被自动调整）

### 3. 数据加载
- **有记录**：如果选择的日期有记录，自动加载分数和描述
- **无记录**：如果选择的日期没有记录，清空输入框，可以创建新记录

### 4. 创建和更新
- **创建新记录**：选择没有记录的日期，输入分数和描述后保存，会创建新记录
- **更新记录**：选择已有记录的日期，修改后保存，会更新记录

## 使用流程

1. **打开修改界面**
   - 点击主界面的"修改历史记录"按钮

2. **选择日期**
   - 从年份下拉列表中选择年份
   - 从月份下拉列表中选择月份
   - 从日期下拉列表中选择日期
   - 系统自动计算该月的天数并更新日期选项

3. **查看/编辑数据**
   - 如果该日期有记录，分数和描述会自动加载
   - 如果该日期没有记录，输入框为空，可以输入新数据

4. **保存**
   - 输入或修改分数（0-100）
   - 输入或修改描述
   - 点击"保存修改"按钮
   - 系统会创建新记录或更新已有记录

## 技术实现

### 日期计算
使用Python的`calendar`模块计算每月天数：
```python
import calendar

def get_days_in_month(self, year, month):
    """获取指定年月的天数"""
    return calendar.monthrange(int(year), int(month))[1]
```

### 事件处理
- `update_day_spinner`：当年或月改变时，更新日期选择器的天数
- `on_date_components_selected`：当年、月、日都选择后，加载该日期的数据

### 日期格式化
日期统一格式化为 `YYYY-MM-DD` 格式：
```python
selected_date = f"{int(year):04d}-{int(month):02d}-{int(day):02d}"
```

## 界面布局

### 日期选择器布局
```
┌─────────────────────────────┐
│  选择日期:                   │
│  [年: 2024] [月: 1] [日: 15] │
└─────────────────────────────┘
```

### 响应式设计
- **Android**：较小的字体和间距，适合小屏幕
- **桌面**：较大的字体和间距，适合大屏幕

## 特殊处理

### 闰年处理
- 2月在平年有28天，在闰年有29天
- 使用`calendar.monthrange()`自动处理闰年

### 日期边界处理
- 如果当前选择的日期超出新月份的范围，自动选择该月最后一天
- 例如：从1月31日切换到2月，自动选择2月28日（或29日）

### 数据加载逻辑
```python
score_data = self.data_manager.get_score(date_str)
if score_data:
    # 有记录：加载数据
    self.edit_score_input.text = str(score_data.get('score', ''))
    self.edit_desc_input.text = score_data.get('desc', '')
else:
    # 无记录：清空输入框
    self.edit_score_input.text = ''
    self.edit_desc_input.text = ''
```

## 优势

1. **灵活性**：可以选择任意日期，不受已有记录限制
2. **易用性**：三级选择器比输入日期字符串更直观
3. **准确性**：自动处理月份天数，避免无效日期
4. **智能性**：自动加载已有数据，减少输入工作

## 测试建议

1. **基本功能**
   - 选择不同年份、月份，验证日期选项是否正确更新
   - 选择有记录的日期，验证数据是否正确加载
   - 选择没有记录的日期，验证可以创建新记录

2. **边界测试**
   - 测试2月在不同年份的天数（平年28天，闰年29天）
   - 测试从大月份（31天）切换到小月份（30天或28/29天）
   - 测试年份边界（当前年份±10年）

3. **数据一致性**
   - 创建新记录后验证是否正确保存
   - 修改记录后验证是否正确更新
   - 验证主界面统计信息是否正确更新

## 与旧版本的对比

### 旧版本
- 只能选择已有记录的日期
- 使用单个Spinner显示所有日期
- 无法创建新日期的记录

### 新版本
- 可以选择任意日期
- 使用年、月、日三级选择器
- 可以创建新日期的记录
- 自动处理月份天数变化

